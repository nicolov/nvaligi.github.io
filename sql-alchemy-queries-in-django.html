<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="//nicolovaligi.com/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="//nicolovaligi.com/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="//nicolovaligi.com/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Nicolò Valigi">
  <meta name="description" content="Posts and writings by Nicolò Valigi">


<meta name="keywords" content="backend, django">

  <title>
SQLAlchemy queries in Django -
    Nicolò Valigi
  </title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67820015-1', 'auto');
  ga('send', 'pageview');

</script></head>

<body>
  <aside>
    <div id="user_meta">
      <a href="//nicolovaligi.com">
        <img src="/blog/images/logo_white.jpg" alt="logo">
      </a>
      <h2><a href="//nicolovaligi.com">Nicolò Valigi</a></h2>
      <p>Writing about Software, Robots, and Machine Learning.</p>
      <ul class="links">
        <li><a href="/pages/talks.html">Talks</a></li>
        <li><a href="/pages/robotics-for-developers-tutorial.html">Robotics for developers</a></li>
        <li><a href="/pages/research.html">Research</a></li>
      </ul>

      <ul style="padding-left: 0;
                 margin-left: -5px;
                 list-style: none;
                 text-align: center;">
        <li>
            <a href="https://github.com/nicolov">
                <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
            </a>
        </li>
        <li>
            <a href="mailto:nicolo.valigi@gmail.com">
                <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                </span>
            </a>
        </li>
    </ul>

    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="//nicolovaligi.com">Index</a> &nbsp; &brvbar; &nbsp;
      <a href="//nicolovaligi.com/tags.html">Tags</a> &nbsp; &brvbar; &nbsp;
      <a href="//nicolovaligi.com/archives.html">Archives</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="//nicolovaligi.com/sql-alchemy-queries-in-django.html">SQLAlchemy queries in Django</a></h1>
  </div>
  <div class="article_text">
    <p>Django's ORM is great for 99% of the common web development use cases. Every now and then, however, a bit more flexibility would go a long way and help stay out of the raw SQL rabbit hole. For example, reporting queries are difficult to build with Django's API and could benefit from a little more abstraction.</p>
<p>In this respect, I believe that SQLAlchemy's <a href="http://docs.sqlalchemy.org/en/latest/core/tutorial.html">SQL Expression Engine</a> allows for significant flexibility with neat and reusable code. In this piece, we will look at how to write queries with the Expression Engine and have them executed by Django's DB engine without additional configuration.</p>
<h2>Integrating Django and SQLAlchemy</h2>
<p>The great <a href="https://github.com/Deepwalker/aldjemy">aldjemy</a> package makes the initial integration painless, and sets up SQLAlchemy to reuse Django's DB connection.</p>
<p>However, its README focuses on on ORM-style queries using SQLAlchemy's own ORM API. Instead, let's look at how to extract the table information to run our own queries built using the expression engine.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aldjemy.core</span> <span class="kn">import</span> <span class="n">get_tables</span><span class="p">,</span> <span class="n">get_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">select</span>

<span class="c1"># for the default DB</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">()</span>
<span class="c1"># for another DB</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">get_engine</span><span class="p">(</span><span class="s1">'tracking'</span><span class="p">)</span>

<span class="c1"># a dict with DB tables</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">get_tables</span><span class="p">()</span>

<span class="c1"># each table can now be accessed to build queries:</span>
<span class="n">widgets</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="s1">'widgets'</span><span class="p">]</span>

<span class="n">query</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</pre></div>
<h2>Running the query</h2>
<p>Since the <code>engine</code> object is already available, we can just open a connection and run the query:</p>
<div class="highlight"><pre><span></span>conn = engine.connect()
result = conn.execute(query)
</pre></div>
<p>As an added note, I've found <a href="http://pandas.pydata.org">Pandas</a> to be very useful in these kinds of situations. In fact, easy column and row-level operations at the Python level nicely complement the flexibility in data retrieval afforded by SQLAlchemy.</p>
<p>When using Pandas, fetching the query results into a DataFrame is even easier:</p>
<div class="highlight"><pre><span></span>data_frame = pandas.read_sql_query(query, engine)
</pre></div>
<h2>Under the hood</h2>
<p>While Django doesn't support connection pooling, it obviously has its own transaction system which is syncronized with the request/response cycle. Aldjemy plugs into this with the <code>core.DjangoPool</code> class which operates as a SQLAlchemy <code>NullPool</code> that piggybacks on Django's connections. Each connection is wrapped in a <code>wrapper.Wrapper</code> to disable SQLAlchemy's handling of transactions and rely on Django's.</p>
<p>Tables are generated through reflection of Django's models in the <code>tables.generate_tables</code> function. Aldjemy keeps a mapping of Django field types to SQLAlchemy types and iterates through each model to add the relevant columns to its table.</p>
<h2>Conclusions</h2>
<p>We have seen how to use SQLAlchemy's SQL Expression Language to run complex queries on Django's database without needing to create additional connections or manually define the database schema.</p>
  </div>
  <div class="article_meta">
    <p>Posted on: ven 02 ottobre 2015</p>
    <p>Category: <a href="//nicolovaligi.com/category/2015.html">2015</a>
 &ndash; Tags:
      <a href="//nicolovaligi.com/tag/backend.html">backend</a>,      <a href="//nicolovaligi.com/tag/django.html">django</a>    </p>
  </div>


</article>


    <div id="ending_message">
      <p>&copy; Nicolò Valigi. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme originally by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>