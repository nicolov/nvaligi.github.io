<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="//nicolovaligi.com/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="//nicolovaligi.com/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="//nicolovaligi.com/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Nicolò Valigi">
  <meta name="description" content="Posts and writings by Nicolò Valigi">


<meta name="keywords" content="backend, django">

  <title>
Continous integration with Django and Protractor -
    Nicolò Valigi
  </title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67820015-1', 'auto');
  ga('send', 'pageview');

</script></head>

<body>
  <aside>
    <div id="user_meta">
      <a href="//nicolovaligi.com">
        <img src="/blog/images/logo_white.jpg" alt="logo">
      </a>
      <h2><a href="//nicolovaligi.com">Nicolò Valigi</a></h2>
      <p>Writing about Software, Robots, and Machine Learning.</p>
      <ul class="links">
        <li><a href="/pages/talks.html">Talks</a></li>
        <li><a href="/pages/robotics-for-developers-tutorial.html">Robotics for developers</a></li>
        <li><a href="/pages/research.html">Research</a></li>
      </ul>

      <ul style="padding-left: 0;
                 margin-left: -5px;
                 list-style: none;
                 text-align: center;">
        <li>
            <a href="https://github.com/nicolov">
                <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
            </a>
        </li>
        <li>
            <a href="mailto:nicolo.valigi@gmail.com">
                <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                </span>
            </a>
        </li>
    </ul>

    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="//nicolovaligi.com">Index</a> &nbsp; &brvbar; &nbsp;
      <a href="//nicolovaligi.com/tags.html">Tags</a> &nbsp; &brvbar; &nbsp;
      <a href="//nicolovaligi.com/archives.html">Archives</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="//nicolovaligi.com/continous-integration-django-protractor.html">Continous integration with Django and Protractor</a></h1>
  </div>
  <div class="article_text">
    <p>Continous integration is a catchy term to refer to the software engineering practice of frequently committing to the <code>master</code> branch and running automated tests. Failing builds are tagged so that developers can (in theory) immediately drop everything they are doing to fix them.</p>
<p>Besides the criticisms one could raise from an organizational perspective (a nice analysis is <a href="http://www.yegor256.com/2014/10/08/continuous-integration-is-dead.html">here</a>), doing CI right means having a reliable set of automated tests that run with appropriate database-backed data. This is somewhat of a challenge with the modern SPA + REST API setup, since the backend and frontend will each have a different set of unit and integration tests expecting certain rows in the database.</p>
<p>In this article we are going to look at the popular Django+Angular configuration and lay down an architecture to easily integrate both testing suites (and run them on CircleCI).</p>
<h2>The problem with Protractor</h2>
<p>Protractor is the de-facto solution for end-to-end testing of Angular.JS applications. Specifications ("specs") for application behaviour can be written following the Jasmine API and easily run from the command line:</p>
<div class="highlight"><pre><span></span>protractor protractor.conf.js --specs="specs/my_spec.js"
</pre></div>
<p>The problem with this setup is that each spec may potentially require a different set of data in the database. Django and DRF (as usual) brilliantly solve the issue by allowing the user to declare a fixture when defining the <code>TestCase</code>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">ExampleTests</span>(<span class="n">APITestCase</span>):
    <span class="n">fixtures</span> = [...]

    <span class="n">def</span> <span class="n">setUp</span>(<span class="k">self</span>):
        ...
</pre></div>
<p>Looking at the problem, we see two potential solutions:</p>
<ul>
<li>script the automated testing so that Django management commands <code>flush</code> and <code>loaddata</code> are run before each Protractor spec, creating a new database and loading the necessary data.</li>
<li>wrap Protractor tests inside a Django management command that sets up a new database, loads the appropriate fixtures, and spawns a Protractor process.</li>
</ul>
<p>We will be looking at the second approach, for its DRY awesomeness.</p>
<h2>A Django management command</h2>
<p>There's an interesting <a href="https://github.com/jpulec/django-protractor">project on GitHub</a> offering a tidy Mixin to Django's unit testing classes that spawns a Protractor process with given fixtures. While neat, this is no solution for us because it only ever uses Django's development (and static file) server. I tend to believe that integration tests should be run with as close a configuration to production as possible. In our case, this means that protractor should load the pages through the <em>gunicorn/nginx</em> stack.</p>
<p>On the other hand, not having access to Django's testing classes (that automatically set up and tear down new databases) means handling these jobs ourselves. What came out is a management command that takes command line arguments for both django fixtures and protractor specs:</p>
<div class="highlight"><pre><span></span>python manage.py protractor
    --protractor-conf="protractor/conf.js"
    --fixture="protractor/fixture_a.json"
    --fixture="protractor/fixture_b.json"
    --specs="protractor/spec_1.spec.js"
</pre></div>
<h2>Running everything on CircleCI</h2>
<p>Now that all work has been delegated to the management command, all that needs to be done to run protractor tests in CircleCI is to add lines similar to the one above to the <code>test: override:</code> array in the circle.yml file. As noted below, please keep in mind that the command does <em>not</em> support parallel testing, since each process shares the same, single, database (unlike normal Django tests that set up their own databases).</p>
<h2>Conclusions</h2>
<p>Thorough testing requires not only a fair number of test cases, but a variety of different situations as well. To solve this issue, we have shown code for a Django management command that wraps protractor processes to load appropriate database fixtures.</p>
<h2>The code</h2>
<p>The management command below <strong>flushes</strong> the database before loading the fixtures requested on the command line. So be careful not to run this on databases with valuable data. The CircleCI VM is obviously fine.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">make_option</span>

<span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">call_command</span>
<span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.test.runner</span> <span class="kn">import</span> <span class="n">setup_databases</span>

<span class="kn">from</span> <span class="nn">south.management.commands</span> <span class="kn">import</span> <span class="n">patch_for_test_db_setup</span>

<span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="s1">'[--protractor-conf] [--runserver-command] [--specs] [--suite]'</span>

    <span class="n">option_list</span> <span class="o">=</span> <span class="n">BaseCommand</span><span class="o">.</span><span class="n">option_list</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">make_option</span><span class="p">(</span><span class="s1">'--protractor-conf'</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">'protractor_conf'</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s1">'protractor.conf.js'</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">'Specify a destination for your protractor configuration'</span>
        <span class="p">),</span>
        <span class="n">make_option</span><span class="p">(</span><span class="s1">'--specs'</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">'specs'</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">'Specify which specs to run'</span>
        <span class="p">),</span>
        <span class="n">make_option</span><span class="p">(</span><span class="s1">'--suite'</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">'store'</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">'suite'</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">'Specify which suite to run'</span>
        <span class="p">),</span>
        <span class="n">make_option</span><span class="p">(</span><span class="s1">'--fixture'</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s1">'append'</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s1">'fixtures'</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">'Specify fixture to load initial data to the database'</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">'verbosity'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'verbosity'</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">'protractor_conf'</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Could not find '{}'"</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">'protractor_conf'</span><span class="p">]))</span>

        <span class="c1"># flush the database</span>
        <span class="n">call_command</span><span class="p">(</span><span class="s1">'flush'</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">fixtures</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">'fixtures'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fixtures</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fixture</span> <span class="ow">in</span> <span class="n">fixtures</span><span class="p">:</span>
                <span class="n">call_command</span><span class="p">(</span><span class="s1">'loaddata'</span><span class="p">,</span> <span class="n">fixture</span><span class="p">,</span>
                             <span class="o">**</span><span class="p">{</span><span class="s1">'verbosity'</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s1">'verbosity'</span><span class="p">]})</span>

        <span class="n">protractor_command</span> <span class="o">=</span> <span class="s1">'protractor {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">'protractor_conf'</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">'specs'</span><span class="p">]:</span>
            <span class="n">protractor_command</span> <span class="o">+=</span> <span class="s1">' --specs {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">'specs'</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">'suite'</span><span class="p">]:</span>
            <span class="n">protractor_command</span> <span class="o">+=</span> <span class="s1">' --suite {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">'suite'</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Running protractor..</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">protractor_command</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">protractor_command</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">return_code</span><span class="p">)</span>
</pre></div>
  </div>
  <div class="article_meta">
    <p>Posted on: mer 10 giugno 2015</p>
    <p>Category: <a href="//nicolovaligi.com/category/2015.html">2015</a>
 &ndash; Tags:
      <a href="//nicolovaligi.com/tag/backend.html">backend</a>,      <a href="//nicolovaligi.com/tag/django.html">django</a>    </p>
  </div>


</article>


    <div id="ending_message">
      <p>&copy; Nicolò Valigi. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme originally by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>